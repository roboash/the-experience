<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Eye Chase — Platformer (Extended Level)</title>
<style>
:root{--bg:#071022;--ground:#0d2a3f;--player:#7afcff;--plat:#6ea8ff;--spike:#ff5b5b;--eye:#ff2a2a;--pupil:#000;--bounce:#7cff7a}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071022,#030717);color:#dff6ff;display:flex;align-items:center;justify-content:center}
.wrap{width:min(1024px,96vw);padding:18px}
.hud{display:flex;gap:12px;align-items:center;margin-bottom:8px}
button{background:#1b2a44;color:#dff6ff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
.muted{color:#9fbff9;font-size:13px}
canvas{background:linear-gradient(180deg,#071228,#031021);display:block;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.overlay{position:absolute;left:0;right:0;text-align:center;color:#fff}
</style>
</head>
<body>
<div class="wrap">
<div class="hud">
<button id="startBtn">Start</button>
<button id="restartBtn">Restart</button>
<div class="muted">Move: A/D or Left/Right • Jump: Space / W / Up • Start/Restart: Enter</div>
<div style="flex:1"></div>
<div class="muted">Best: <span id="best">0</span></div>
</div>
<div style="position:relative">
<canvas id="c" width="1024" height="576" tabindex="0" aria-label="Platformer eye chase"></canvas>
<div id="msg" class="overlay" style="top:40%;font-size:28px;display:none"></div>
</div>
<script>
const c=document.getElementById('c');
const x=c.getContext('2d');
const W=1024,H=576;

let gameRunning=false,score=0,bestScore=localStorage.getItem('eyeChaseBest')||0;
document.getElementById('best').textContent=bestScore;
let camera=0,goalReached=false,countdown=3,gameLoopId=null;

const player={x:150,y:466,w:30,h:30,vy:0,speed:3,jumpForce:-22,grounded:false,rotation:0,doubleJump:true};
const eye={x:150-250,y:466-50,w:175,h:175,speed:3};
let obstacles=[];
const groundY=H-80;
let goal={x:0,y:groundY-40,r:55};

function generateLevel(){
  obstacles=[];
  let posX=0;
  for(let i=0;i<8;i++){ obstacles.push({x:posX,y:groundY,w:100,h:80,type:'ground'}); posX+=100; }
  
  const segments=[
    {type:'platform',platformY:groundY-60,width:180, style:'high'},
    {type:'platform',platformY:groundY-90,width:150, style:'gap'},
    {type:'platform',platformY:groundY-70,width:200, style:'spike'},
    {type:'platform',platformY:groundY-80,width:160, style:'bounce'}
  ];

  const repeatCount=Math.ceil(30000/posX);
  for(let r=0;r<repeatCount;r++){
    for(const seg of segments){
      if(seg.style==='high') seg.platformY=groundY-150;
      else if(seg.style==='gap') seg.platformY=groundY-50;
      else if(seg.style==='spike') seg.platformY=groundY-80;
      else if(seg.style==='bounce') seg.platformY=groundY-100;

      obstacles.push({x:posX,y:seg.platformY,w:seg.width,h:20,type:seg.type});
      obstacles.push({x:posX,y:groundY,w:seg.width,h:80,type:'ground'});
      
      if(seg.style==='spike'){
        const spikeWidth=30;
        const numSpikes=Math.floor(seg.width/spikeWidth);
        for(let i=0;i<numSpikes;i++){
          obstacles.push({x:posX+i*spikeWidth,y:groundY-20,w:spikeWidth,h:20,type:'spike',flipped:true});
        }
      }
      posX+=seg.width+50;
    }
  }
  for(let i=0;i<5;i++){ obstacles.push({x:posX,y:groundY,w:100,h:80,type:'ground'}); posX+=100; }
  goal.x=posX+50; goal.y=groundY-40;
}

const keys={};
window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(['w',' ','arrowup'].includes(e.key.toLowerCase())){
    if(gameRunning){
      if(player.grounded){
        player.vy=player.jumpForce; player.grounded=false; player.doubleJump=true;
      } else if(player.doubleJump){
        player.vy=player.jumpForce; player.doubleJump=false;
      }
    }
  }
  if(e.key==='Enter'){ startGame();} 
});
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

function collision(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }

function updatePlayer(){
  if(keys['a']||keys['arrowleft']) player.x-=player.speed;
  if(keys['d']||keys['arrowright']) player.x+=player.speed;
  player.vy+=2.2; player.y+=player.vy;
  player.grounded=false;
  let lowestCollision=null;
  for(let o of obstacles){
    if(collision(player,o)){
      if(o.type==='spike'){ resetPlayer(); return; }
      if(o.type==='ground'||o.type==='platform'){ 
        if(player.vy>0 && player.y+player.h-player.vy<o.y+5){ 
          if(!lowestCollision || o.y<lowestCollision.y) lowestCollision=o; 
        } 
      }
    }
  }
  if(lowestCollision){ player.y=lowestCollision.y-player.h; player.vy=0; player.grounded=true; player.doubleJump=true; }
  if(collision(player, {x:eye.x, y:eye.y, w:eye.w, h:eye.h})){ resetPlayer(); return; }
  if(player.y>H+50) resetPlayer();
  const goalBox={x:goal.x-goal.r,y:goal.y-goal.r,w:goal.r*2,h:goal.r*2}; if(collision(player,goalBox)) reachGoal();
  camera=player.x-200;
}

function updateEye(){
  const dx=player.x-(eye.x+eye.w/2);
  const dy=player.y-(eye.y+eye.h/2);
  const dist=Math.sqrt(dx*dx+dy*dy);
  const speed=eye.speed;
  if(dist>0){ eye.x+=dx/dist*speed; eye.y+=dy/dist*speed; }
}

function draw(){
  x.fillStyle='#071022'; x.fillRect(0,0,W,H);
  x.save(); x.translate(-camera,0);
  for(let o of obstacles){
    if(o.type==='ground'){ x.fillStyle='#0e2f4f'; x.fillRect(o.x,o.y,o.w,o.h); }
    else if(o.type==='platform'){ x.fillStyle='#81b8ff'; x.fillRect(o.x,o.y,o.w,o.h); }
    else if(o.type==='spike'){ x.fillStyle='#ff5b5b'; x.beginPath();
      if(o.flipped){ x.moveTo(o.x,o.y+o.h); x.lineTo(o.x+o.w/2,o.y); x.lineTo(o.x+o.w,o.y+o.h); } 
      else { x.moveTo(o.x,o.y); x.lineTo(o.x+o.w/2,o.y+o.h); x.lineTo(o.x+o.w,o.y); }
      x.closePath(); x.fill(); }
  }
  x.fillStyle='#7afcff'; x.fillRect(player.x,player.y,player.w,player.h);

  const eyeCenterX=eye.x+eye.w/2, eyeCenterY=eye.y+eye.h/2;
  x.fillStyle='#ff2a2a'; x.beginPath(); x.arc(eyeCenterX,eyeCenterY,eye.w/2,0,Math.PI*2); x.fill();
  const angle=Math.atan2(player.y-eyeCenterY, player.x-eyeCenterX);
  const pupilOffset=eye.w/5;
  const pupilSize=eye.w/8;
  const pupilX=eyeCenterX+Math.cos(angle)*pupilOffset;
  const pupilY=eyeCenterY+Math.sin(angle)*pupilOffset;
  x.fillStyle='#000'; x.beginPath(); x.arc(pupilX,pupilY,pupilSize,0,Math.PI*2); x.fill();

  x.restore();
  if(!gameRunning && countdown>0){
    x.fillStyle='#fff'; x.font='72px Inter, system-ui'; x.textAlign='center';
    x.fillText(Math.ceil(countdown), W/2, H/2);
  }
}

function resetPlayer(){
  cancelAnimationFrame(gameLoopId);
  player.x=150; player.y=466; player.vy=0; player.grounded=false; player.doubleJump=true;
  eye.x=150-250; eye.y=466-50;
  camera=0; countdown=3; gameRunning=false;
  document.getElementById('msg').innerHTML='You Died — Press Enter to restart';
  document.getElementById('msg').style.display='block';
}

function gameLoop(){
  if(!gameRunning){
    if(countdown>0){ countdown-=0.016; draw(); gameLoopId=requestAnimationFrame(gameLoop); return; }
    gameRunning=true; document.getElementById('msg').style.display='none';
  }
  updatePlayer(); updateEye(); draw(); score=player.x; gameLoopId=requestAnimationFrame(gameLoop);
}

function reachGoal(){ gameRunning=false; countdown=3; document.getElementById('msg').innerHTML='Level Complete! — Press Enter to restart'; document.getElementById('msg').style.display='block';}

function startGame(){ 
  cancelAnimationFrame(gameLoopId);
  player.x=150; player.y=466; player.vy=0; player.grounded=false; player.doubleJump=true;
  eye.x=150-250; eye.y=466-50; camera=0; 
  countdown=3; 
  generateLevel(); 
  gameLoop();
}

document.getElementById('startBtn').onclick=startGame;
document.getElementById('restartBtn').onclick=startGame;
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Eye Chase — Platformer (Extended Level)</title>
<style>
:root{--bg:#071022;--ground:#0d2a3f;--player:#7afcff;--plat:#6ea8ff;--spike:#ff5b5b;--eye:#ff2a2a;--pupil:#000;--bounce:#7cff7a}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071022,#030717);color:#dff6ff;display:flex;align-items:center;justify-content:center}
.wrap{width:min(1024px,96vw);padding:18px}
.hud{display:flex;gap:12px;align-items:center;margin-bottom:8px}
button{background:#1b2a44;color:#dff6ff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
.muted{color:#9fbff9;font-size:13px}
canvas{background:linear-gradient(180deg,#071228,#031021);display:block;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.overlay{position:absolute;left:0;right:0;text-align:center;color:#fff}
</style>
</head>
<body>
<div class="wrap">
<div class="hud">
<button id="startBtn">Start</button>
<button id="restartBtn">Restart</button>
<div class="muted">Move: A/D or Left/Right • Jump: Space / W / Up • Start/Restart: Enter</div>
<div style="flex:1"></div>
<div class="muted">Best: <span id="best">0</span></div>
</div>
<div style="position:relative">
<canvas id="c" width="1024" height="576" tabindex="0" aria-label="Platformer eye chase"></canvas>
<div id="msg" class="overlay" style="top:40%;font-size:28px;display:none"></div>
</div>
<script>
const c=document.getElementById('c');
const x=c.getContext('2d');
const W=1024,H=576;

let gameRunning=false,score=0,bestScore=localStorage.getItem('eyeChaseBest')||0;
document.getElementById('best').textContent=bestScore;
let camera=0,goalReached=false,countdown=3,gameLoopId=null;

const player={x:150,y:466,w:30,h:30,vy:0,speed:3,jumpForce:-22,grounded:false,rotation:0,doubleJump:true};
const eye={x:150-250,y:466-50,w:175,h:175,speed:3};
let obstacles=[];
const groundY=H-80;
let goal={x:0,y:groundY-40,r:55};

function generateLevel(){
  obstacles=[];
  let posX=0;
  for(let i=0;i<8;i++){ obstacles.push({x:posX,y:groundY,w:100,h:80,type:'ground'}); posX+=100; }
  
  const segments=[
    {type:'platform',platformY:groundY-60,width:180, style:'high'},
    {type:'platform',platformY:groundY-90,width:150, style:'gap'},
    {type:'platform',platformY:groundY-70,width:200, style:'spike'},
    {type:'platform',platformY:groundY-80,width:160, style:'bounce'}
  ];

  const repeatCount=Math.ceil(30000/posX);
  for(let r=0;r<repeatCount;r++){
    for(const seg of segments){
      if(seg.style==='high') seg.platformY=groundY-150;
      else if(seg.style==='gap') seg.platformY=groundY-50;
      else if(seg.style==='spike') seg.platformY=groundY-80;
      else if(seg.style==='bounce') seg.platformY=groundY-100;

      obstacles.push({x:posX,y:seg.platformY,w:seg.width,h:20,type:seg.type});
      obstacles.push({x:posX,y:groundY,w:seg.width,h:80,type:'ground'});
      
      if(seg.style==='spike'){
        const spikeWidth=30;
        const numSpikes=Math.floor(seg.width/spikeWidth);
        for(let i=0;i<numSpikes;i++){
          obstacles.push({x:posX+i*spikeWidth,y:groundY-20,w:spikeWidth,h:20,type:'spike',flipped:true});
        }
      }
      posX+=seg.width+50;
    }
  }
  for(let i=0;i<5;i++){ obstacles.push({x:posX,y:groundY,w:100,h:80,type:'ground'}); posX+=100; }
  goal.x=posX+50; goal.y=groundY-40;
}

const keys={};
window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(['w',' ','arrowup'].includes(e.key.toLowerCase())){
    if(gameRunning){
      if(player.grounded){
        player.vy=player.jumpForce; player.grounded=false; player.doubleJump=true;
      } else if(player.doubleJump){
        player.vy=player.jumpForce; player.doubleJump=false;
      }
    }
  }
  if(e.key==='Enter'){ startGame();} 
});
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

function collision(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }

function updatePlayer(){
  if(keys['a']||keys['arrowleft']) player.x-=player.speed;
  if(keys['d']||keys['arrowright']) player.x+=player.speed;
  player.vy+=2.2; player.y+=player.vy;
  player.grounded=false;
  let lowestCollision=null;
  for(let o of obstacles){
    if(collision(player,o)){
      if(o.type==='spike'){ resetPlayer(); return; }
      if(o.type==='ground'||o.type==='platform'){ 
        if(player.vy>0 && player.y+player.h-player.vy<o.y+5){ 
          if(!lowestCollision || o.y<lowestCollision.y) lowestCollision=o; 
        } 
      }
    }
  }
  if(lowestCollision){ player.y=lowestCollision.y-player.h; player.vy=0; player.grounded=true; player.doubleJump=true; }
  if(collision(player, {x:eye.x, y:eye.y, w:eye.w, h:eye.h})){ resetPlayer(); return; }
  if(player.y>H+50) resetPlayer();
  const goalBox={x:goal.x-goal.r,y:goal.y-goal.r,w:goal.r*2,h:goal.r*2}; if(collision(player,goalBox)) reachGoal();
  camera=player.x-200;
}

function updateEye(){
  const dx=player.x-(eye.x+eye.w/2);
  const dy=player.y-(eye.y+eye.h/2);
  const dist=Math.sqrt(dx*dx+dy*dy);
  const speed=eye.speed;
  if(dist>0){ eye.x+=dx/dist*speed; eye.y+=dy/dist*speed; }
}

function draw(){
  x.fillStyle='#071022'; x.fillRect(0,0,W,H);
  x.save(); x.translate(-camera,0);
  for(let o of obstacles){
    if(o.type==='ground'){ x.fillStyle='#0e2f4f'; x.fillRect(o.x,o.y,o.w,o.h); }
    else if(o.type==='platform'){ x.fillStyle='#81b8ff'; x.fillRect(o.x,o.y,o.w,o.h); }
    else if(o.type==='spike'){ x.fillStyle='#ff5b5b'; x.beginPath();
      if(o.flipped){ x.moveTo(o.x,o.y+o.h); x.lineTo(o.x+o.w/2,o.y); x.lineTo(o.x+o.w,o.y+o.h); } 
      else { x.moveTo(o.x,o.y); x.lineTo(o.x+o.w/2,o.y+o.h); x.lineTo(o.x+o.w,o.y); }
      x.closePath(); x.fill(); }
  }
  x.fillStyle='#7afcff'; x.fillRect(player.x,player.y,player.w,player.h);

  const eyeCenterX=eye.x+eye.w/2, eyeCenterY=eye.y+eye.h/2;
  x.fillStyle='#ff2a2a'; x.beginPath(); x.arc(eyeCenterX,eyeCenterY,eye.w/2,0,Math.PI*2); x.fill();
  const angle=Math.atan2(player.y-eyeCenterY, player.x-eyeCenterX);
  const pupilOffset=eye.w/5;
  const pupilSize=eye.w/8;
  const pupilX=eyeCenterX+Math.cos(angle)*pupilOffset;
  const pupilY=eyeCenterY+Math.sin(angle)*pupilOffset;
  x.fillStyle='#000'; x.beginPath(); x.arc(pupilX,pupilY,pupilSize,0,Math.PI*2); x.fill();

  x.restore();
  if(!gameRunning && countdown>0){
    x.fillStyle='#fff'; x.font='72px Inter, system-ui'; x.textAlign='center';
    x.fillText(Math.ceil(countdown), W/2, H/2);
  }
}

function resetPlayer(){
  cancelAnimationFrame(gameLoopId);
  player.x=150; player.y=466; player.vy=0; player.grounded=false; player.doubleJump=true;
  eye.x=150-250; eye.y=466-50;
  camera=0; countdown=3; gameRunning=false;
  document.getElementById('msg').innerHTML='You Died — Press Enter to restart';
  document.getElementById('msg').style.display='block';
}

function gameLoop(){
  if(!gameRunning){
    if(countdown>0){ countdown-=0.016; draw(); gameLoopId=requestAnimationFrame(gameLoop); return; }
    gameRunning=true; document.getElementById('msg').style.display='none';
  }
  updatePlayer(); updateEye(); draw(); score=player.x; gameLoopId=requestAnimationFrame(gameLoop);
}

function reachGoal(){ gameRunning=false; countdown=3; document.getElementById('msg').innerHTML='Level Complete! — Press Enter to restart'; document.getElementById('msg').style.display='block';}

function startGame(){ 
  cancelAnimationFrame(gameLoopId);
  player.x=150; player.y=466; player.vy=0; player.grounded=false; player.doubleJump=true;
  eye.x=150-250; eye.y=466-50; camera=0; 
  countdown=3; 
  generateLevel(); 
  gameLoop();
}

document.getElementById('startBtn').onclick=startGame;
document.getElementById('restartBtn').onclick=startGame;
</script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Eye Chase — Platformer (Extended Level)</title>
<style>
:root{--bg:#071022;--ground:#0d2a3f;--player:#7afcff;--plat:#6ea8ff;--spike:#ff5b5b;--eye:#ff2a2a;--pupil:#000;--bounce:#7cff7a}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071022,#030717);color:#dff6ff;display:flex;align-items:center;justify-content:center}
.wrap{width:min(1024px,96vw);padding:18px}
.hud{display:flex;gap:12px;align-items:center;margin-bottom:8px}
button{background:#1b2a44;color:#dff6ff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
.muted{color:#9fbff9;font-size:13px}
canvas{background:linear-gradient(180deg,#071228,#031021);display:block;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.overlay{position:absolute;left:0;right:0;text-align:center;color:#fff}
</style>
</head>
<body>
<div class="wrap">
<div class="hud">
<button id="startBtn">Start</button>
<button id="restartBtn">Restart</button>
<div class="muted">Move: A/D or Left/Right • Jump: Space / W / Up • Start/Restart: Enter</div>
<div style="flex:1"></div>
<div class="muted">Best: <span id="best">0</span></div>
</div>
<div style="position:relative">
<canvas id="c" width="1024" height="576" tabindex="0" aria-label="Platformer eye chase"></canvas>
<div id="msg" class="overlay" style="top:40%;font-size:28px;display:none"></div>
</div>
<script>
const c=document.getElementById('c');
const x=c.getContext('2d');
const W=1024,H=576;

let gameRunning=false,score=0,bestScore=localStorage.getItem('eyeChaseBest')||0;
document.getElementById('best').textContent=bestScore;
let camera=0,goalReached=false,countdown=3,gameLoopId=null;

const player={x:150,y:466,w:30,h:30,vy:0,speed:3,jumpForce:-22,grounded:false,rotation:0,doubleJump:true};
const eye={x:150-250,y:466-50,w:175,h:175,speed:3};
let obstacles=[];
const groundY=H-80;
let goal={x:0,y:groundY-40,r:55};

function generateLevel(){
  obstacles=[];
  let posX=0;
  for(let i=0;i<8;i++){ obstacles.push({x:posX,y:groundY,w:100,h:80,type:'ground'}); posX+=100; }
  
  const segments=[
    {type:'platform',platformY:groundY-60,width:180, style:'high'},
    {type:'platform',platformY:groundY-90,width:150, style:'gap'},
    {type:'platform',platformY:groundY-70,width:200, style:'spike'},
    {type:'platform',platformY:groundY-80,width:160, style:'bounce'}
  ];

  const repeatCount=Math.ceil(30000/posX);
  for(let r=0;r<repeatCount;r++){
    for(const seg of segments){
      if(seg.style==='high') seg.platformY=groundY-150;
      else if(seg.style==='gap') seg.platformY=groundY-50;
      else if(seg.style==='spike') seg.platformY=groundY-80;
      else if(seg.style==='bounce') seg.platformY=groundY-100;

      obstacles.push({x:posX,y:seg.platformY,w:seg.width,h:20,type:seg.type});
      obstacles.push({x:posX,y:groundY,w:seg.width,h:80,type:'ground'});
      
      if(seg.style==='spike'){
        const spikeWidth=30;
        const numSpikes=Math.floor(seg.width/spikeWidth);
        for(let i=0;i<numSpikes;i++){
          obstacles.push({x:posX+i*spikeWidth,y:groundY-20,w:spikeWidth,h:20,type:'spike',flipped:true});
        }
      }
      posX+=seg.width+50;
    }
  }
  for(let i=0;i<5;i++){ obstacles.push({x:posX,y:groundY,w:100,h:80,type:'ground'}); posX+=100; }
  goal.x=posX+50; goal.y=groundY-40;
}

const keys={};
window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(['w',' ','arrowup'].includes(e.key.toLowerCase())){
    if(gameRunning){
      if(player.grounded){
        player.vy=player.jumpForce; player.grounded=false; player.doubleJump=true;
      } else if(player.doubleJump){
        player.vy=player.jumpForce; player.doubleJump=false;
      }
    }
  }
  if(e.key==='Enter'){ startGame();} 
});
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

function collision(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }

function updatePlayer(){
  if(keys['a']||keys['arrowleft']) player.x-=player.speed;
  if(keys['d']||keys['arrowright']) player.x+=player.speed;
  player.vy+=2.2; player.y+=player.vy;
  player.grounded=false;
  let lowestCollision=null;
  for(let o of obstacles){
    if(collision(player,o)){
      if(o.type==='spike'){ resetPlayer(); return; }
      if(o.type==='ground'||o.type==='platform'){ 
        if(player.vy>0 && player.y+player.h-player.vy<o.y+5){ 
          if(!lowestCollision || o.y<lowestCollision.y) lowestCollision=o; 
        } 
      }
    }
  }
  if(lowestCollision){ player.y=lowestCollision.y-player.h; player.vy=0; player.grounded=true; player.doubleJump=true; }
  if(collision(player, {x:eye.x, y:eye.y, w:eye.w, h:eye.h})){ resetPlayer(); return; }
  if(player.y>H+50) resetPlayer();
  const goalBox={x:goal.x-goal.r,y:goal.y-goal.r,w:goal.r*2,h:goal.r*2}; if(collision(player,goalBox)) reachGoal();
  camera=player.x-200;
}

function updateEye(){
  const dx=player.x-(eye.x+eye.w/2);
  const dy=player.y-(eye.y+eye.h/2);
  const dist=Math.sqrt(dx*dx+dy*dy);
  const speed=eye.speed;
  if(dist>0){ eye.x+=dx/dist*speed; eye.y+=dy/dist*speed; }
}

function draw(){
  x.fillStyle='#071022'; x.fillRect(0,0,W,H);
  x.save(); x.translate(-camera,0);
  for(let o of obstacles){
    if(o.type==='ground'){ x.fillStyle='#0e2f4f'; x.fillRect(o.x,o.y,o.w,o.h); }
    else if(o.type==='platform'){ x.fillStyle='#81b8ff'; x.fillRect(o.x,o.y,o.w,o.h); }
    else if(o.type==='spike'){ x.fillStyle='#ff5b5b'; x.beginPath();
      if(o.flipped){ x.moveTo(o.x,o.y+o.h); x.lineTo(o.x+o.w/2,o.y); x.lineTo(o.x+o.w,o.y+o.h); } 
      else { x.moveTo(o.x,o.y); x.lineTo(o.x+o.w/2,o.y+o.h); x.lineTo(o.x+o.w,o.y); }
      x.closePath(); x.fill(); }
  }
  x.fillStyle='#7afcff'; x.fillRect(player.x,player.y,player.w,player.h);

  const eyeCenterX=eye.x+eye.w/2, eyeCenterY=eye.y+eye.h/2;
  x.fillStyle='#ff2a2a'; x.beginPath(); x.arc(eyeCenterX,eyeCenterY,eye.w/2,0,Math.PI*2); x.fill();
  const angle=Math.atan2(player.y-eyeCenterY, player.x-eyeCenterX);
  const pupilOffset=eye.w/5;
  const pupilSize=eye.w/8;
  const pupilX=eyeCenterX+Math.cos(angle)*pupilOffset;
  const pupilY=eyeCenterY+Math.sin(angle)*pupilOffset;
  x.fillStyle='#000'; x.beginPath(); x.arc(pupilX,pupilY,pupilSize,0,Math.PI*2); x.fill();

  x.restore();
  if(!gameRunning && countdown>0){
    x.fillStyle='#fff'; x.font='72px Inter, system-ui'; x.textAlign='center';
    x.fillText(Math.ceil(countdown), W/2, H/2);
  }
}

function resetPlayer(){
  cancelAnimationFrame(gameLoopId);
  player.x=150; player.y=466; player.vy=0; player.grounded=false; player.doubleJump=true;
  eye.x=150-250; eye.y=466-50;
  camera=0; countdown=3; gameRunning=false;
  document.getElementById('msg').innerHTML='You Died — Press Enter to restart';
  document.getElementById('msg').style.display='block';
}

function gameLoop(){
  if(!gameRunning){
    if(countdown>0){ countdown-=0.016; draw(); gameLoopId=requestAnimationFrame(gameLoop); return; }
    gameRunning=true; document.getElementById('msg').style.display='none';
  }
  updatePlayer(); updateEye(); draw(); score=player.x; gameLoopId=requestAnimationFrame(gameLoop);
}

function reachGoal(){ gameRunning=false; countdown=3; document.getElementById('msg').innerHTML='Level Complete! — Press Enter to restart'; document.getElementById('msg').style.display='block';}

function startGame(){ 
  cancelAnimationFrame(gameLoopId);
  player.x=150; player.y=466; player.vy=0; player.grounded=false; player.doubleJump=true;
  eye.x=150-250; eye.y=466-50; camera=0; 
  countdown=3; 
  generateLevel(); 
  gameLoop();
}

document.getElementById('startBtn').onclick=startGame;
document.getElementById('restartBtn').onclick=startGame;
</script>
</body>
</html>
